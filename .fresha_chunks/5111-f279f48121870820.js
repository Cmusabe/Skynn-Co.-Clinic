try{!function(){var e="u">typeof window?window:"u">typeof global?global:"u">typeof globalThis?globalThis:"u">typeof self?self:{},t=(new e.Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="57770f72-d8e5-4440-bdc2-05374c8040af",e._sentryDebugIdIdentifier="sentry-dbid-57770f72-d8e5-4440-bdc2-05374c8040af")}()}catch(e){}(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5111],{14008:(e,t,n)=>{"use strict";n.d(t,{n:()=>d});var a=n(37876),r=n(14232),o=n(98552),s=n(344),c=n(95179),l=n(81631),i=n(83301),u=n(76045);let d=(0,r.forwardRef)((e,t)=>{let{paymentsProvider:n,adyenClientKey:d,isLoading:p,providerCountryCode:y,WrapperComponent:m,tokenize:h,...f}=e,{isOpen:P,onClose:_,onOpen:g,setOpen:w,paymentModalDisclaimer:A,editCurrentCard:C,onBack:v,onError:b,onSuccess:S}=f,{getSelectedPaymentMethods:k,isChallengeVisible:E,errorHandling:O,handlePaymentAction:M,isPaymentSelectionReady:R}=(0,l.S)();(0,r.useEffect)(()=>{P&&R&&(s.m3.paymentsCardFormShown({provider:n}),(0,i.g)("payments_card_form_shown"))},[P,n,R]);let F=(0,r.useCallback)(async()=>(s.m3.paymentsCardFormClosed(),(0,i.g)("payments_card_form_closed"),_?_():Promise.resolve()),[_]),x=(0,r.useMemo)(()=>m&&n===c.wF.Adyen?e=>{let{children:t}=e;return(0,a.jsx)(m,{edit:C,disclaimer:A,isOpen:!E&&P,onClose:F,onOpen:g,setOpen:w,onBack:v,children:t})}:null,[m,n,P,F,g,w,A,C,v,E]),D=(0,r.useCallback)(async e=>(w?.(!1),O.handlePaymentError(e),O.reopenParentModalRef&&w&&(O.reopenParentModalRef.current=async()=>w(!0)),b?.(e)),[O,b,w]);switch(n){case c.wF.Adyen:{if(!d)return null;if(!M)throw Error("handlePaymentAction is required for Adyen provider to handle 3DS challenges");let e=k().some(e=>"PaymentOneOffCard"===e.paymentMethod);return(0,a.jsx)(u._,{...f,ref:t,countryCode:y,adyenClientKey:d,onPaymentActionRequired:M,isLoadingExternal:p,Wrapper:x,tokenize:e,onError:D,onSuccess:S})}case c.wF.Checkout:return(0,a.jsx)(o.aC,{ref:t,providerCountryCode:y,tokenizeOnly:h??!1,isLoading:p,WrapperComponent:m,onError:b,onSuccess:S,...f});default:return null}});d.displayName="PaymentForm"},43060:e=>{e.exports={applePayButton:"ApplePayButton_applePayButton__Sa8lf"}},46297:(e,t,n)=>{"use strict";n.d(t,{$e:()=>y,KH:()=>P,Mp:()=>p,QA:()=>g,S3:()=>m,aH:()=>_,tp:()=>f});var a=n(28933),r=n(78621),o=n(67627),s=n(14232),c=n(344),l=n(30475),i=n(40439),u=n(1438),d=n(83301);let p=a.MpY,y={SUPPORTS_3DS:"supports3DS",SUPPORTS_CREDIT:"supportsCredit",SUPPORTS_DEBIT:"supportsDebit",SUPPORTS_EMV:"supportsEMV"},m=e=>e?.__typename==="PaymentApplePay",h={3:["amex","chinaUnionPay","discover","interac","jcb","masterCard","privateLabel","visa","mada"],8:["amex","chinaUnionPay","discover","interac","masterCard","privateLabel","visa","jcb","cartesBancaires","eftpos","electron","maestro","vPay","elo","mada"]};class f extends Error{constructor(e){super(),this.originalError=e}}class P extends Error{constructor(e){super(),this.originalError=e}}class _ extends Error{constructor(e){super(),this.originalError=e}}let g=e=>{let{applePayLabel:t,countryCode:n,currency:a,paymentMethods:g}=e,[w,A]=(0,s.useState)(!1),[C,v]=(0,s.useState)(!1),{createApplePaySession:b}=(e=>{let{countryCode:t}=e,{trigger:n}=(0,i.$9)(p);return{createApplePaySession:(0,s.useCallback)(async()=>{let{errors:e,result:a}=await n({countryCode:t});if(e?.length)throw e.length>1?e:e[0];return JSON.parse(a.createApplePaySessionByCountry.token)},[t,n])}})({countryCode:n}),[S,k]=(0,s.useState)(8),{applePayData:E,canInitiateApplePay:O}=(e=>{let{applePayLabel:t,applePayPaymentMethod:n,countryCode:a,currency:r}=e,o=!!a&&!!r&&!!t&&!!n;return{applePayData:(0,s.useMemo)(()=>{if(!o)return;let{webMerchantId:e,merchantName:t,supportedNetworks:s,webMerchantCapabilities:c}=(0,l.gy)(n);return{countryCode:a,currency:r,merchantIdentifier:e||"",merchantName:t||"",supportedNetworks:s||[],webMerchantCapabilities:c||[]}},[n,a,r,o]),canInitiateApplePay:o}})({applePayLabel:t,applePayPaymentMethod:g?.map(e=>(0,l.gy)(e)).find(m),countryCode:n,currency:a});(0,s.useEffect)(()=>{if(C||!(O&&E))return;let e=!0;return(async()=>{try{if(!window.ApplePaySession){e&&A(!1);return}let t=await new Promise((e,t)=>{if(ApplePaySession.applePayCapabilities)return void e(ApplePaySession);let n=document.createElement("script");n.src="https://applepay.cdn-apple.com/jsapi/1.latest/apple-pay-sdk.js",n.async=!0,n.onload=()=>{ApplePaySession.applePayCapabilities?e(ApplePaySession):t(Error("ApplePaySession.applePayCapabilities method not available after SDK load"))},n.onerror=()=>t(Error("Failed to load Apple Pay SDK")),document.head.appendChild(n)}),n=8;switch(!t.supportsVersion(8)&&(n=3,(0,u.qO)(Error("Apple Pay v8 not supported by device, falling back to v3"),{},{source:"Payments"})),e&&k(n),(await t.applePayCapabilities(E.merchantIdentifier)).paymentCredentialStatus){case"paymentCredentialsAvailable":case"paymentCredentialStatusUnknown":e&&(c.m3.paymentsApplePayAvailable(),(0,d.g)("payments_apple_pay_available"),A(!0));break;default:e&&A(!1)}}catch(t){(0,u.Oz)(t,{msg:"Unable to check ApplePay availability"},{source:"Payments"}),e&&A(!1)}finally{e&&v(!0)}})(),()=>{e=!1}},[C,O,E]);let M=(0,s.useCallback)(e=>{try{if(!(w&&E))throw new P(Error("Cannot initialise Apple Pay Session instance"));let n=e.amount,a=h[S],s=(0,r.E)(E.supportedNetworks,a),c=(0,o.I)(E.supportedNetworks,s);c.length>0&&(0,u.Oz)(Error("Unsupported Apple Pay networks filtered out"),{msg:"Apple Pay networks not supported by version",version:S,unsupportedNetworks:c,allNetworks:E.supportedNetworks},{source:"Payments"});let l={countryCode:E.countryCode,currencyCode:E.currency,merchantCapabilities:E.webMerchantCapabilities.map(e=>y[e]),supportedNetworks:s,total:{label:t,amount:String(n),type:"final"},shippingType:"storePickup"};return new ApplePaySession(S,l)}catch(e){(0,u.Oz)(e,{msg:"Unable to create Apple Pay session",supportedNetworks:E?.supportedNetworks},{source:"Payments"})}},[w,E,t,S]);return{canInitiateApplePay:O,canUseApplePay:w,hasInitiated:C,isLoading:O&&!C,payWithApplePay:(0,s.useCallback)((e,t)=>{if(!e)throw c.m3.paymentsApplePayFailed(),(0,d.g)("payments_apple_pay_failed"),new P(Error("Session not initialised"));return new Promise((n,a)=>{let r=!1;e.onvalidatemerchant=async t=>{try{let t=await b();r||e.completeMerchantValidation(t)}catch(t){(0,u.Oz)(t,{msg:"Unable to complete merchant validation",hasCancelled:r},{source:"Payments"}),r||e.abort(),a(t)}},e.onpaymentauthorized=async o=>{try{let a=o.payment,s=btoa(JSON.stringify(a.token.paymentData)),l=a.token.paymentMethod.displayName;await t({displayName:l,applePayToken:s}),r||e.completePayment(ApplePaySession.STATUS_SUCCESS),c.m3.paymentsApplePaySucceeded(),(0,d.g)("payments_apple_pay_succeeded"),n()}catch(t){(0,u.Oz)(t,{msg:"Unable to pay with Apple Pay after the payment was authorized",hasCancelled:r},{source:"Payments"}),r||e.completePayment(ApplePaySession.STATUS_FAILURE),c.m3.paymentsApplePayFailed(),(0,d.g)("payments_apple_pay_failed"),a(new _(t))}},e.oncancel=()=>{r=!0,c.m3.paymentsApplePayCancelled(),(0,d.g)("payments_apple_pay_cancelled"),a(new f(Error("User cancelled Apple Pay")))};try{e.begin()}catch(e){c.m3.paymentsApplePayFailed(),(0,d.g)("payments_apple_pay_failed"),a(new P(e))}})},[b]),initialiseApplePay:M}}},54809:(e,t,n)=>{"use strict";n.d(t,{S:()=>_});var a=n(28933),r=n(69111),o=n(14232),s=n(36249),c=n(344),l=n(30475),i=n(3491),u=n(95179),d=n(1299),p=n(30451),y=n(57992),m=n(83301),h=n(92072),f=n(60759);let P=a.dYS;function _(e){let{handlePaymentError:t,provider:n,subscription:a,paymentsScope:_,paymentsCountryCode:g}=e,{redirectTo:w}=(0,r.c)(),A=(0,d.r)(),C=(0,s.ok)(),v=C?.get("redirectResult"),b=C?.get("payment-id"),S=!!b,k=(0,o.useRef)(!1),E=(0,o.useCallback)((e,t)=>{let a=(()=>{switch(n){case u.wF.Adyen:{let{redirectResult:e}=t;return{adyen:{redirectResult:e}}}case u.wF.Checkout:throw Error("Payment redirect flow not supported in Checkout.com context");default:throw new p.N(n)}})();if(_&&g){let e=C?(0,f.S)([...C.entries()]):[],t=(0,y.Zm)(e);(0,y.$K)({payments_scope:_,payments_provider:n,payments_country_code:g,payments_methods_selected:t})}return c.m3.paymentsIdealRedirectCompleted(),(0,m.g)("payments_ideal_redirect_completed"),(0,i.L)(P,{id:e,actionResult:a})},[n,_,g,C]),[O,M]=(0,o.useState)(S),[R,F]=(0,o.useState)(!1),{PaymentChallenge:x,startChallenge:D,isChallengeVisible:T}=(0,h.h)(),j=(0,o.useCallback)(async(e,t)=>{switch(e.challenge?.__typename){case"PaymentActionIDealRedirect":e.challenge.url&&(c.m3.paymentsIdealRedirectStarted(),(0,m.g)("payments_ideal_redirect_started"),window.location.href=e.challenge.url);break;case"PaymentActionAdyen3DSChallenge":case"PaymentActionCheckout3DSChallenge":{let n=(0,l.gy)(e.challenge);return await D(e.id,n,t)}case void 0:case null:return;default:throw new p.N(e.challenge)}},[D]),I=(0,o.useCallback)(()=>{let e=new URLSearchParams(C);for(let t of["redirectResult","payment-id"])e.delete(t);w({pathname:A,search:e.toString()})},[A,w,C]);return(0,o.useEffect)(()=>{b&&a&&!k.current&&(k.current=!0,I(),(async()=>{try{let e=await E(b,{redirectResult:v});if(e.errors?.length)throw e.errors;c.m3.paymentsTransactionCompleted(),(0,m.g)("payments_transaction_completed"),F(!0)}catch(e){c.m3.paymentsTransactionFailed(),(0,m.g)("payments_transaction_failed"),M(!1),F(!1),t(e)}})())},[t,E,b,v,I,a]),{handlePaymentAction:j,hasCompletedPayment:R,hasMadePayment:O,hasFinalisedPaymentThroughRedirect:k.current,isChallengeVisible:T,PaymentChallenge:x,setHasCompletedPayment:F,setHasMadePayment:M}}},57992:(e,t,n)=>{"use strict";n.d(t,{$K:()=>s,AL:()=>c,Zm:()=>l});var a=n(1438),r=n(88584),o=n(88399);function s(e,t){(0,r.ZB)(e,"Payments",t)}function c(e){(0,r.wz)(e,"Payments")}function l(e){try{let t=Array.isArray(e)?e:Object.values(e).filter(o.xF).map(e=>e.__typename);return JSON.stringify(t.sort())}catch(e){return(0,a.Oz)(e,{msg:"Failed to serialize payment methods"},{source:"Payments"}),"<unknown>"}}},60759:(e,t,n)=>{"use strict";n.d(t,{S:()=>v,B:()=>b});var a=n(69111),r=n(14232),o=n(36249),s=n(38454),c=n(344),l=n(30475),i=n(3491),u=n(1299),d=n(1438),p=n(88399),y=n(95696),m=n(57992),h=n(83301),f=n(52054),P=n(89304);let _=n(28933).FmU,g={PaymentCardOnFile:"pay-with-card-on-file",PaymentApplePay:"pay-with-apple-pay",PaymentIDeal:"pay-with-ideal",PaymentFreshaAccount:"pay-with-fresha-account",PaymentOneOffCard:"pay-with-one-off-card",PaymentProviderAccount:"pay-with-provider-account"},w=Object.values(g),A=e=>g[e],C=e=>Object.entries(g).find(t=>{let[n,a]=t;return a===e})?.[0];function v(e){return e.filter(e=>{let[t]=e;return t.startsWith("pay-with-")}).map(e=>{let[t]=e;return C(t)}).filter(p.Tn)}let b=e=>{let{amount:t,availablePaymentMethods:n,clientSupportStatus:b,getOutstandingBalance:S,isLoadingPaymentMethods:k,setOutstandingBalance:E,validateSelectedPaymentMethodsVariables:O,hasFinalisedPaymentThroughRedirect:M}=e,R=(0,o.ok)(),F=R.toString(),x=(0,r.useRef)(R);x.current=R;let D=(0,u.r)(),{redirectTo:T}=(0,a.c)(),j=(0,s.Q)(),I=(0,r.useRef)(O);I.current=O;let[N,z]=(0,r.useState)(!1),U=Object.values(b).every(e=>null!=e.isSupported),B=(0,r.useRef)(!1),L=(0,r.useCallback)(e=>{var t;let a,r,o=v(e);return a=(t=U?n.filter(e=>o.includes(e.__typename)&&b[e.__typename]?.isSupported!==!1):[]).find(e=>(0,P.s)(e)),r=t.find(e=>(0,f.S)(e)),{freshaAccount:(0,l.gy)(a)??null,providerAccount:(0,l.gy)(r)??null,card:t.find(e=>"CARD"===e.category)??null}},[n,U,b]),$=(0,r.useCallback)(e=>({...Object.fromEntries([...x.current.entries()].filter(e=>{let[t]=e;return!C(t)})),...e.freshaAccount&&{[A("PaymentFreshaAccount")]:"1"},...e.providerAccount&&{[A("PaymentProviderAccount")]:"1"},...e.card&&{[A(e.card.__typename)]:"1"}}),[F]),K=(0,r.useMemo)(()=>L([...x.current.entries()]),[L,F]),[q,J]=(0,r.useState)(()=>[K.card?.__typename,K.freshaAccount?.__typename,K.providerAccount?.__typename].filter(p.Tn)),V=(0,r.useCallback)(e=>{J(a=>{let r="function"==typeof e?e(a):e;if(r.includes("PaymentApplePay")){let e=r.includes("PaymentFreshaAccount")?n.find(P.s):void 0,o=r.includes("PaymentProviderAccount")?n.find(f.S):void 0,{providerAccount:{providerId:s}={}}=(0,l.gy)(o)??{},c=[e&&{freshaAccount:{id:e.id}},o&&s&&{providerAccount:{providerId:s}}].filter(p.Tn);(a.length||c.length?S(c):Promise.resolve(t)).then(e=>{E(e??t)}).catch(e=>{(0,d.Oz)(e,{msg:"Error refreshing outstanding balance for Apple Pay",area:"useSelectedPaymentMethodsBackend",amount:String(t),stateSummary:{prevSelectedCount:a.length,nextSelectedCount:r.length,excludedPaymentsCount:c.length}},{source:"Payments",paymentMethodType:"PaymentApplePay"})})}return r})},[t,n,S,E]),X=(0,r.useMemo)(()=>{let e=q.find(e=>"PaymentFreshaAccount"!==e&&"PaymentProviderAccount"!==e);return{freshaAccount:q.includes("PaymentFreshaAccount")?n.find(e=>"PaymentFreshaAccount"===e.__typename)??null:null,providerAccount:q.includes("PaymentProviderAccount")?n.find(e=>"PaymentProviderAccount"===e.__typename)??null:null,card:e?n.find(t=>t.__typename===e)??null:null}},[n,q]),Z=(0,r.useMemo)(()=>Object.values(n.reduce((e,t)=>{if(!t.autoSelection||b[t.__typename]?.isSupported===!1)return e;let{group:n,priority:a}=t.autoSelection;return!e[n]||a<e[n].priority?{...e,[n]:{method:t,priority:a}}:e},{})).map(e=>e.method.__typename).sort(),[n,b]),H=(0,r.useRef)(Z);(0,r.useEffect)(()=>{let e=v([...x.current.entries()]),t=Z.length!==H.current.length||!Z.every((e,t)=>e===H.current[t]);if(B.current&&Z.length&&(!e.length||t)&&(B.current=!1,e.length||z(!1)),!U||B.current||k)return;let n=Object.fromEntries([...[...x.current.entries()].filter(e=>{let[t]=e;return!w.includes(t)}),...Z.map(e=>[A(e),"1"])]);B.current=!0,H.current=Z,V(Z),z(!0),Z.length&&T({hash:j,pathname:D,query:n})},[Z,U,b,v,j,k,D,T,F]);let[Y,W]=(0,r.useState)(!1),Q=(0,r.useRef)(!1),G=(0,r.useRef)(0);(0,r.useEffect)(()=>()=>window.clearTimeout(G.current),[]);let ee=(0,r.useCallback)(e=>{if(Q.current)return;let t="function"==typeof e?e(X):e,n=Object.values(t).filter(p.Tn).map(e=>e.__typename);c.m3.paymentsMethodsSelectionRequested({methods:n}),(0,h.g)("payments_methods_selection_requested",{payments_methods_selected_next:(0,m.Zm)(n)}),T({hash:j,pathname:D,query:$({...X,...t})})},[$,j,D,T,X]),et=(0,r.useRef)(K),en=(0,r.useCallback)(()=>{c.m3.paymentsMethodsSelectionReset(),(0,h.g)("payments_methods_selection_reset"),T({hash:j,pathname:D,query:{...Object.fromEntries([...x.current.entries()].filter(e=>{let[t]=e;return!C(t)})),...X.freshaAccount&&{[A("PaymentFreshaAccount")]:"1"},...X.providerAccount&&{[A("PaymentProviderAccount")]:"1"},...X.card&&{[A(X.card.__typename)]:"1"}}})},[j,D,T,F,X]),ea=(0,y.X)(async()=>{let e;if(K.card?.__typename===X.card?.__typename&&K.freshaAccount?.__typename===X.freshaAccount?.__typename&&K.providerAccount?.__typename===X.providerAccount?.__typename)return void z(!0);Q.current=!0;let n=0;G.current=window.setTimeout(()=>{n=performance.now(),W(!0)},1e3);try{if(K.card?.__typename!==X?.card?.__typename?e=K.card?.__typename??X?.card?.__typename:!!K.freshaAccount?.__typename!=!!X?.freshaAccount?.__typename?e="PaymentFreshaAccount":!!K.providerAccount?.__typename!=!!X?.providerAccount?.__typename&&(e="PaymentProviderAccount"),!e)return;let n={...I.current,amount:t,clientSupportsApplePay:!!b.PaymentApplePay?.isSupported,selection:e,previousSelections:[X.card?.__typename,X.freshaAccount?.__typename,X.providerAccount?.__typename].filter(p.Tn)},a=await (0,i.L)(_,n);if(a.errors)throw a.errors;let r=a?.data?.selectedPaymentMethods?.edges.map(e=>e.node.__typename).filter(e=>"PaymentGiftCard"!==e)??[],o=Object.fromEntries([...[...R.entries()].filter(e=>{let[t]=e;return!w.includes(t)}),...r.filter(e=>e in g).map(e=>A(e)).filter(p.Tn).map(e=>[e,"1"])??[]]);V(r),M||(c.m3.paymentsMethodsSelection({methods:r}),(0,h.g)("payments_methods_selection",{payments_methods_selected_next:(0,m.Zm)(r),payments_methods_selected:(0,m.Zm)(X)})),T({hash:j,pathname:D,query:o})}catch(n){(0,d.Oz)(n,{amount:t,selection:e,selectedPaymentMethods:JSON.stringify(X),msg:"Unable to validate payment selections"},{source:"Payments"}),en()}finally{Q.current=!1,window.clearTimeout(G.current),G.current=window.setTimeout(()=>W(!1),Math.max(300,300-(performance.now()-n))),z(!0)}});return(0,r.useEffect)(()=>{!k&&(K.card||K.freshaAccount||K.providerAccount)&&K!==et.current&&(et.current=K,ea())},[k,K,ea]),{isDisabled:Y,isReady:N&&!k,requestedPaymentMethods:K,selectedPaymentMethods:X,setSelectedPaymentMethods:ee}}},65111:(e,t,n)=>{"use strict";n.d(t,{yp:()=>I,VT:()=>j});var a=n(37876),r=n(64820),o=n(49995),s=n(14232),c=n(66296),l=n(344),i=n(30475),u=n(61928),d=n(40439),p=n(95179),y=n(1438),m=n(88399),h=n(30451),f=n(95696),P=n(43060),_=n.n(P),g=n(37773),w=n(86237),A=n(46297),C=n(52707),v=n(4358),b=n(21031),S=n(34700),k=n(14008);let E=e=>{let{adyenClientKey:t,countryCode:n,isOpen:o,onCancel:c,onError:l,onSubmit:i,paymentProviderType:u,setOpen:d,isLoading:p,setLoading:y}=e,m=(0,s.useRef)(void 0),h=(0,s.useCallback)(async()=>{try{let e=await m.current?.validate();if(Object.values(e??{}).some(Boolean))return;await m.current?.submit()}catch(e){l(e)}},[l]),P=(0,s.useCallback)(()=>y(!1),[y]),_=(0,s.useCallback)(async e=>{i(e)},[i]),g=(0,f.X)(async e=>l(e));return(0,a.jsx)(v.Yf,{footer:(0,a.jsxs)(C.e,{direction:"horizontal",wrap:"nowrap",children:[(0,a.jsx)(r.$,{isFull:!0,onAction:c,shape:"square",size:"l",variant:"secondary",children:(0,b.__)`Cancel`}),(0,a.jsx)(r.$,{isFull:!0,isPending:p,onAction:h,shape:"square",size:"l",variant:"primary",children:(0,b.__)`Pay`})]}),isOpen:o,setOpen:d,title:(0,b.tS)("Payment form","Add credit or debit card"),children:(0,a.jsx)(k.n,{adyenClientKey:t,paymentsProvider:u,providerCountryCode:n,onError:g,onLoadingComplete:P,onSubmitCard:_,ref:m,tokenize:!0,isOpen:o})})};var O=n(54809),M=n(1101),R=n(60759),F=n(81631),x=n(57992),D=n(83301);let T=e=>{let{loading:t=!1,payNow:n,paymentMethods:s,children:c,EXPERIMENTAL__showApplePayButton:l=!1,...i}=e;return s.some(e=>"PaymentApplePay"===e.paymentMethod)&&l?t?(0,a.jsx)(r.$,{size:"l",isFull:!0,isPending:!0,onAction:()=>Promise.resolve(),children:null}):(0,a.jsx)("button",{className:(0,o.A)("apple-pay-button",_().applePayButton),type:"button",onClick:n,"data-qa":"apple-pay-button"}):(0,a.jsx)(r.$,{variant:"primary",...i,isPending:t,onAction:n,children:c})};function j(){let e=(0,s.useRef)(void 0),{clearPaymentError:t,handlePaymentError:n,paymentError:r}=(0,c.Mn)(),o=(0,f.X)(async()=>{t(),await e?.current?.(),e.current=void 0}),l=r?(0,a.jsx)(c.eb,{error:r,isWarningModalOpen:!!r,onClose:o}):null;return{error:r,handlePaymentError:n,PaymentError:l,reopenParentModalRef:e}}function I(e){var t,n;let r,{adyenClientKey:o,amount:c,applePayLabel:P,children:_,countryCode:C,currency:v,getOutstandingBalance:b,isLoadingPaymentMethods:I,isPaid:N,initialisePayment:z,onPaid:U,paymentMethods:B,provider:L,subscription:$,subscriptionVariables:K,validateSelectedPaymentMethodsVariables:q}=e,J=j(),{handlePaymentAction:V,hasCompletedPayment:X,hasMadePayment:Z,isChallengeVisible:H,PaymentChallenge:Y,setHasCompletedPayment:W,setHasMadePayment:Q,hasFinalisedPaymentThroughRedirect:G}=(0,O.S)({handlePaymentError:J.handlePaymentError,provider:L,subscription:$,paymentsScope:q.scope,paymentsCountryCode:C}),[ee,et]=(0,s.useState)(c),{canInitiateApplePay:en,hasInitiated:ea,isLoading:er,payWithApplePay:eo,canUseApplePay:es,initialiseApplePay:ec}=(0,A.QA)({applePayLabel:P,countryCode:C,currency:v,paymentMethods:B}),el=(0,s.useRef)(null),ei=(0,s.useMemo)(()=>B?.map(e=>(0,i.gy)(e)).filter(m.xF).filter(e=>"PaymentGiftCard"!==e.__typename)??[],[B]),eu=(0,s.useMemo)(()=>({PaymentApplePay:{isSupported:en&&!ea||er?null:es}}),[en,es,ea,er]),ed=(0,s.useMemo)(()=>ei.filter(e=>void 0===eu[e.__typename]||eu[e.__typename]?.isSupported),[ei,eu]),ep=function(e){let{adyenClientKey:t,availablePaymentMethods:n,countryCode:r,provider:o}=e,{closeModal:c,isOpen:l,openModal:i,setOpen:u}=(0,S.V)({key:"add-one-off-card",replace:!0}),d=(0,s.useRef)(()=>{}),p=(0,s.useRef)(()=>{}),[y,m]=(0,s.useState)(!0),h=(0,s.useCallback)(e=>p.current(e),[]),f=(0,s.useCallback)(e=>d.current(e),[]),P=(0,s.useCallback)(()=>{d.current(null),c()},[c]),_=(0,s.useCallback)(e=>{e||d.current(null),u(e)},[u]);return{addCard:(0,s.useCallback)(async()=>{try{return await i(),await new Promise((e,t)=>{d.current=e,p.current=t})}finally{await c()}},[c,i]),Form:n?.some(e=>e?.__typename==="PaymentOneOffCard")?(0,a.jsx)(E,{adyenClientKey:t,countryCode:r??"",isOpen:l,onCancel:P,onError:h,onSubmit:f,paymentProviderType:o,setOpen:_,isLoading:y,setLoading:m}):null}}({adyenClientKey:o,availablePaymentMethods:ei,countryCode:C,provider:L}),ey=(0,s.useMemo)(()=>b||(e=>((0,y.Oz)(Error("getOutstandingBalance is undefined"),{msg:"getOutstandingBalance callback was called but is undefined",excludedPayments:JSON.stringify(e.map(e=>e.providerAccount?"PaymentProviderAccount":e.freshaAccount?"PaymentFreshaAccount":void 0).filter(m.xF))},{source:"Payments"}),Promise.resolve(void 0))),[b]),{isDisabled:em,isReady:eh,requestedPaymentMethods:ef,selectedPaymentMethods:eP,setSelectedPaymentMethods:e_}=(0,R.B)({amount:c,clientSupportStatus:eu,getOutstandingBalance:ey,isLoadingPaymentMethods:I||Object.values(eu).some(e=>null===e),availablePaymentMethods:ei,setOutstandingBalance:et,validateSelectedPaymentMethodsVariables:q,hasFinalisedPaymentThroughRedirect:G}),eg=(0,s.useRef)(!1);(0,s.useLayoutEffect)(()=>{let e=q.scope;if((0,x.$K)({payments_scope:e,payments_provider:L,payments_country_code:C}),!eh)return;let t=(0,x.Zm)(eP);if((0,x.$K)({payments_methods_selected:t},{acceptConflicts:!0}),!eg.current&&!G){let e=(0,x.Zm)(eP);(0,x.$K)({payments_methods_auto_selected:e}),(0,D.g)("payments_initialised"),eg.current=!0}},[q.scope,L,C,eh,eP,G]),(0,s.useEffect)(()=>()=>{(0,x.AL)(["payments_methods_auto_selected","payments_methods_selected","payments_provider","payments_scope","payments_country_code"])},[]);let{isRecalculatingBalance:ew}=function(e){let{amount:t,selectedPaymentMethods:n,getOutstandingBalance:a,setOutstandingBalance:r}=e,o=(0,s.useRef)(t),c=(0,s.useRef)(!1),[l,i]=(0,s.useState)(!1),u=(0,w.Y)(e=>{let{card:t,freshaAccount:o,providerAccount:s}=n;if(!(t?.__typename==="PaymentApplePay"&&(o||s))){(0,g.Pw)("Set the outstanding balance upon amount change",{amount:String(e),paymentMethods:JSON.stringify([t?.__typename,o?.__typename,s?.__typename].filter(m.Tn)),source:"Payments"}),r(e);return}i(!0),a([o&&{freshaAccount:{id:o.id}},s&&{providerAccount:{providerId:s.providerAccount.providerId}}].filter(m.Tn)).then(function(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e;(0,g.Pw)("Recalculated the outstanding balance upon amount change",{amount:String(n),paymentMethods:JSON.stringify([t?.__typename,o?.__typename,s?.__typename].filter(m.Tn)),source:"Payments"}),r(n)}).catch(n=>{(0,y.Oz)(n,{msg:"Error recalculating outstanding balance when amount changed",amount:String(e),paymentMethods:JSON.stringify([t?.__typename,o?.__typename,s?.__typename].filter(m.Tn))},{source:"Payments"}),r(e)}).finally(()=>{i(!1)})},300);return(0,s.useEffect)(()=>{if(void 0!==t){if(!c.current){c.current=!0,o.current=t,r(t);return}t!==o.current&&(o.current=t,u(t))}},[t,u,r]),{isRecalculatingBalance:l}}({amount:c,selectedPaymentMethods:eP,getOutstandingBalance:ey,setOutstandingBalance:et,handlePaymentError:J.handlePaymentError}),eA=I||!eh,eC=!eA&&!ew&&!Z&&(!!eP.card||(t=[eP.freshaAccount,eP.providerAccount],n=c??0,r=t.reduce((e,t)=>{switch(t?.__typename){case"PaymentFreshaAccount":return e+t.freshaAccount.balance.amount.value;case"PaymentProviderAccount":return e+(t.providerAccount.balance?.[0]?.amount.value??0);default:return e}},0),t.filter(Boolean).length>0&&r>=n)),{getPaymentInputs:ev,getSelectedPaymentMethods:eb,initialisePayments:eS}=function(e){let{handlePaymentAction:t,initialisePayment:n,provider:a,readyPaymentMethods:r,selectedPaymentMethods:o}=e,s=(0,f.X)(()=>{let e=[];switch(o.freshaAccount&&e.push({paymentMethod:"PaymentFreshaAccount"}),o.providerAccount&&e.push({paymentMethod:"PaymentProviderAccount"}),o.card?.__typename){case"PaymentApplePay":e.push({paymentMethod:"PaymentApplePay"});break;case"PaymentCardOnFile":e.push({paymentMethod:"PaymentCardOnFile"});break;case"PaymentIDeal":e.push({paymentMethod:"PaymentIDeal"});break;case"PaymentOneOffCard":e.push({paymentMethod:"PaymentOneOffCard"});break;case null:case void 0:break;default:throw new h.N(o.card)}return e});return{getPaymentInputs:(0,f.X)(e=>{let{optionsApplePay:t,selectedMethods:n,tokenisedCard:o}=e,s=n.map(e=>{let t=r.find(t=>t.__typename===e.paymentMethod);if(!t)throw Error(`Cannot pay using disallowed payment method ${e.paymentMethod}`);return{...e,readyPaymentMethod:t}});if(!s.length)throw Error("Cannot make payment without at least one selected payment method");return s.map(e=>(e=>{let{paymentMethod:n,readyPaymentMethod:r}=e;switch(n){case"PaymentOneOffCard":return{paymentMethod:p.sP.OneOffCard,oneOffCard:{...a===p.wF.Adyen&&{adyen:{browserInfo:(0,M.V)(),holderName:o.adyen.cardHolderName,...o.adyen.encryptedCardDetails}},...a===p.wF.Checkout&&{checkout:{...o.checkout}}}};case"PaymentApplePay":if(!t)throw Error("Cannot pay using Apple Pay without an initialised Apple Pay token");return{paymentMethod:p.sP.ApplePay,applePay:t};case"PaymentIDeal":{let e=new URL(window.location.toString());return e.hash="",{paymentMethod:p.sP.Ideal,ideal:{returnUrl:e.toString()}}}case"PaymentCardOnFile":return{paymentMethod:p.sP.CardOnFile,cardOnFile:{...a===p.wF.Adyen&&{adyen:{browserInfo:(0,M.V)()}},...a===p.wF.Checkout&&{checkout:{}}}};case"PaymentFreshaAccount":return{paymentMethod:p.sP.FreshaAccount,freshaAccount:{id:r?.id??""}};case"PaymentProviderAccount":{let{providerAccount:e}=(0,i.gy)(r);return{paymentMethod:p.sP.ProviderAccount,providerAccount:{providerId:e.providerId}}}default:throw new h.N(n)}})(e)).filter(m.xF)}),getSelectedPaymentMethods:s,initialisePayments:async(e,a)=>{let r=await n({payments:e});if(!r)return a.current=!0,{isRedirect:!1};let o=r.errors?.slice().sort((e,t)=>!e.extensions?.formattedMessage&&t.extensions?.formattedMessage?1:e.extensions?.formattedMessage&&!t.extensions?.formattedMessage?-1:0)[0];if(o)throw o;let s=(0,i.gy)(r.data);if(!s)return{isRedirect:!1};let c=s.challenge?.__typename==="PaymentActionIDealRedirect";switch(s.result){case"REQUIRES_ACTION":await t(s);break;case"SUCCEEDED":break;default:throw Error("Unsuccessful payment status")}return{isRedirect:c}}}}({handlePaymentAction:V,initialisePayment:z,provider:L,readyPaymentMethods:ed,selectedPaymentMethods:eP}),ek=(0,f.X)(async e=>{let{session:t,autopay:n}=e,a=eb();try{let e;if(n&&!a.length){if(!el.current)throw Error("Add card form ref is missing. Provide the `addCard` ref to `PaymentMethod` so Payments can submit the form during autopay.");if(await el.current?.submit(),!(a=await new Promise(e=>setTimeout(()=>{e(eb())}))).length)return}Q(!0);let r=a.some(e=>"PaymentOneOffCard"===e.paymentMethod),o=r?await ep.addCard():void 0;if(r&&!o)return void Q(!1);let s={current:!1};if(a.some(e=>"PaymentApplePay"===e.paymentMethod))await eo(t,async t=>{let{applePayToken:n,displayName:r}=t,c=(()=>{switch(L){case p.wF.Adyen:return{adyen:{applePayToken:n,browserInfo:(0,M.V)()}};case p.wF.Checkout:return{checkout:{applePayToken:n,displayName:r}};default:throw new h.N(L)}})(),l=ev({optionsApplePay:c,selectedMethods:a,tokenisedCard:o});e=await eS(l,s)});else{let t=ev({optionsApplePay:void 0,selectedMethods:a,tokenisedCard:o});e=await eS(t,s)}if(s.current)return void Q(!1);e.isRedirect||(l.m3.paymentsTransactionCompleted(),(0,D.g)("payments_transaction_completed")),W(!0)}catch(e){if(Q(!1),e instanceof A.tp)return;e instanceof A.KH?((0,y.Oz)(e.originalError,{msg:"Unable to show Apple Pay payment"},{source:"Payments"}),J.handlePaymentError(e.originalError)):e instanceof A.aH?((0,y.Oz)(e.originalError,{msg:"Unable to complete Apple Pay payment"},{source:"Payments"}),J.handlePaymentError(e.originalError)):((0,y.Oz)(e,{msg:"Payment failed",paymentMethods:a.map(e=>e.paymentMethod)},{source:"Payments"}),J.handlePaymentError(e)),l.m3.paymentsTransactionFailed(),(0,D.g)("payments_transaction_failed")}}),eE=(0,s.useRef)(!1),eO=(0,s.useRef)(void 0),eM=(0,s.useRef)(0),eR=X&&!!$,eF=(0,s.useRef)($);$&&(eF.current=$),(0,s.useEffect)(()=>{if(eR)return eM.current=window.setTimeout(()=>{(0,y.Oz)(Error("Payment subscription took too long to resolve"),{subscription:eF.current?(0,u.n)(eF.current).operationName:"<none>"},{source:"PaymentsSubscription"})},1e4),()=>{window.clearTimeout(eM.current)}},[eR]);let ex=(0,f.X)(async e=>{let{data:t,error:n}=e;n!==eO.current&&n?.length?(window.clearTimeout(eM.current),(0,y.Oz)(n,{},{source:"PaymentsSubscription"}),eO.current=n,J.handlePaymentError(n[0]),W(!1),Q(!1),eE.current=!1):!eE.current&&t&&N(t)&&(window.clearTimeout(eM.current),eE.current=!0,U(eP))}),eD=(0,d.NN)(X?$:null,K);(0,s.useEffect)(()=>{ex({data:eD.data,error:eD.error})},[ex,eD.data,eD.error]);let eT=(0,s.useCallback)(e=>{let{EXPERIMENTAL__onAction:t,...n}=e,r=eb(),o=r.some(e=>"PaymentApplePay"===e.paymentMethod);return(0,a.jsx)(T,{loading:n.isPending||Z,paymentMethods:r,payNow:async()=>{if(l.m3.paymentsPayButtonClicked({amount:ee??0}),(0,D.g)("payments_pay_button_clicked",{amount:String(ee??0)}),void 0===ee){(0,y.Oz)("Pay now attempt with no outstanding balance",{},{source:"Payments"}),J.handlePaymentError(Error("Pay now attempt with no outstanding balance"));return}let e=o?ec({amount:ee}):void 0;t?await t(t=>ek({session:e,...t})):await ek({session:e})},...n})},[Z,ek,ee,ec,eb,J]),ej={isChallengeVisible:H,isPaymentSelectionReady:eh,errorHandling:{handlePaymentError:J.handlePaymentError,reopenParentModalRef:J.reopenParentModalRef},getSelectedPaymentMethods:eb,handlePaymentAction:V},eI=(0,a.jsxs)(a.Fragment,{children:[_({canMakePayment:eC,handleError:J.handlePaymentError,hasMadePayment:Z,isLoading:eA,isPaymentSelectionDisabled:em,paymentMethods:ed,requestedPaymentMethods:ef,selectedPaymentMethods:eP,setSelectedPaymentMethods:e_,PayNowButton:eT,addCard:el,PaymentForm:k.n}),Y,J.PaymentError,ep.Form]});return(0,a.jsx)(F.C,{value:ej,children:eI})}},81631:(e,t,n)=>{"use strict";n.d(t,{C:()=>c,S:()=>s});var a=n(37876),r=n(14232);let o=(0,r.createContext)(null);function s(){let e=(0,r.useContext)(o);if(!e)throw Error("usePaymentsContext must be used within PaymentsContextProvider");return e.current}function c(e){let{value:t,children:n}=e,s=(0,r.useRef)(t);return s.current=t,(0,a.jsx)(o.Provider,{value:s,children:n})}},92072:(e,t,n)=>{"use strict";n.d(t,{h:()=>m});var a=n(37876),r=n(14232),o=n(344),s=n(1438),c=n(30451),l=n(83301),i=n(24907),u=n(99280),d=n(3491),p=n(49443);let y=e=>{let t=e.data?.__typename==="PaymentActionCheckout3DSChallenge"?e.data:void 0,n=t.paymentDataId,{onSuccess:o,onFail:s,paymentId:c}=e,l=(0,r.useCallback)((e,t,n)=>(0,d.L)(p.q,{id:e,input:{checkout:{redirectResult:t,paymentDataId:n}}}),[]),i=(0,r.useCallback)(async e=>{try{await l(c,e,n).then(e=>{if(e.errors)throw Error(e.errors[0].message);o()})}catch(e){s(e,{event:void 0,paymentId:c})}},[c,o,s,l,n]),y=(0,r.useCallback)(async e=>{await l(c,"",n),s(Error("3DS-Checkout could not be completed"),{event:void 0,paymentId:c,action:e})},[s,l,c,n]);if(!t||!("paymentDataId"in t))throw Error("Invalid challenge data for checkout 3DS");return(0,a.jsx)(u.Y,{onFail:y,closeModal:()=>Promise.resolve(),url:t.url,onSuccess:i})},m=()=>{let[e,t]=(0,r.useState)(!1),n=(0,r.useRef)(null),u=(0,r.useRef)(null),d=(0,r.useRef)(!1),p=(0,r.useRef)(null),m=(0,r.useCallback)(e=>{t(!1),o.m3.payments3DsChallengeSucceeded(),(0,l.g)("payments_3ds_challenge_succeeded",{payments_card_tokenization:String(d.current)}),p.current?.resolve(e)},[]),h=(0,r.useCallback)((e,a)=>{"<closing>"===a.action?(o.m3.payments3DsChallengeCancelled(),(0,l.g)("payments_3ds_challenge_cancelled",{payments_card_tokenization:String(d.current)})):((0,s.Oz)(e,{__typename:n.current?.__typename,msg:"3DS challenge has failed",event:JSON.stringify(function e(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",a=[];if("object"!=typeof t||null===t)return a;for(let r in t){let o=t[r],s=n?`${n}.${r}`:r;"object"==typeof o&&null!==o?a=a.concat(e(o,s)):a.push(s)}return a}(a.event?.data)),paymentId:a.paymentId,tokenization:String(d.current)},{source:"Payments"}),o.m3.payments3DsChallengeFailed(),(0,l.g)("payments_3ds_challenge_failed",{payments_card_tokenization:String(d.current)})),t(!1),p.current?.reject(e)},[]),f=(0,r.useCallback)((e,a,r)=>{n.current=a,u.current=e,d.current=r?.tokenization??!1,t(!0);let s=a?.__typename==="PaymentActionAdyen3DSChallenge"?"ADYEN":a?.__typename==="PaymentActionCheckout3DSChallenge"?"CHECKOUT":"<unknown>";return o.m3.payments3DsChallengeShown({provider:s}),(0,l.g)("payments_3ds_challenge_shown",{payments_card_tokenization:String(d.current)}),new Promise((e,t)=>{p.current={resolve:e,reject:t}})},[]);return(0,r.useMemo)(()=>{let t=function(e){switch(e){case"PaymentActionAdyen3DSChallenge":return i.X;case"PaymentActionCheckout3DSChallenge":return y;case null:case void 0:return null;default:throw new c.N(e)}}(n.current?.__typename);return{PaymentChallenge:e&&t?(0,a.jsx)(t,{data:n.current,paymentId:u.current,onSuccess:m,onFail:h,tokenization:d.current}):null,startChallenge:f,isChallengeVisible:e}},[f,e,m,h])}}}]);
//# sourceMappingURL=5111-f279f48121870820.js.map